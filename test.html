<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
    <!-- <link href="./init-alpine.js"> -->


    <title>Create ODS HTML output from VA Data</title>


    <script>

        var sampleData = {
            data:
                [
                    [1, '', 4327, 4000, 5000, 0.00505068831944534, 8.217187313450598, 10.682343507485779, 2.4651561940351803],
                    [2, '', 4633, 4000, 5000, 0.015399744210082021, 26.834251492521798, 34.88452694027836, 8.05027544775654],
                    [3, '', 703, 1500, 2500, 0.026463132417610245, 6.986714925382451, 9.082729402997185, 2.096014477614735],
                    [4, '', 1015, 1000, 4000, 0.03662024851127093, 13.967026865722348, 18.15713492543906, 4.190108059716706],
                    [5, '', 3757, 1500, 3500, 0.04593085941072666, 65.12404402989812, 84.66125723886749, 19.53721320896943],
                    [6, '', 7909, 4000, 6000, 0.05575926160074353, 165.45687462696463, 215.0939370150539, 49.63706238808919],
                    [7, '', 5648, 4000, 6000, 0.06565422709399081, 140.09198059701518, 182.11957477611975, 42.02759417910455],
                    [8, '', 13574, 5000, 10000, 0.07656618557431723, 396.2407902987787, 515.113027388412, 118.87223708963282]
                ]
        };

        /* EVENT HANDLERS */
        var self = this;
        var sampleColumnInfo = [{ label: "Risk Category", type: "number" },
        { label: "Policy Slider", type: "number" },
        { label: "Policies", type: "number" },
        { label: "Min Policies", type: "number" },
        { label: "Max Policies", type: "number" },
        { label: "Risk Percentage", type: "number" },
        { label: "VAR_Millions", type: "number" },
        { label: "Premium_Millions", type: "number" },
        { label: "Fees_Millions", type: "number" }
        ];

        if (window.addEventListener) {
            // For standards-compliant web browsers
            window.addEventListener("message", onMessage, false);
        } else {
            window.attachEvent("onmessage", onMessage);
        }

        function onMessage(evt) {
            // console.log(evt.data.availableRowCount)
            if (evt && evt.data) {
                var results = null;
                var columnInfo = null;

                self.resultName = evt.data.resultName;
                // console.log(evt.data.availableRowCount);
                if (evt.data.availableRowCount >= 0) {
                    results = evt.data;
                    columnInfo = evt.data.columns;

                }
                else if (evt.data.availableRowCount == undefined) {
                    results = sampleData;
                    columnInfo = sampleColumnInfo;
                    console.log("sample")
                }
                if (results) {
                    jsonToTable(columnInfo, results.data);
                }

            }
        }



        /*  TABLE CREATION  */

        // Create an HTML DOM element of the given type containing the given text
        function createElementWithText(element, text, format, hide) {
            var e = document.createElement(element);

            if (hide) {
                e.setAttribute('style', "display:none;");
            }

            if (format.name === 'PERCENT' && element == 'td') {
                text = (text * 100).toFixed(format.precision) + '%';

            }
            else if (format.name === 'COMMA' && element == 'td') {
                text = text.toFixed(format.precision)
            }


            e.appendChild(document.createTextNode(text));

            return e;
        }

        // Process the array of CSV data and create a table
        function jsonToTable(columnInfo, jsonData) {

            // Create table
            var tableDivId = 'sample'; // identifier for the table's parent/container
            var tableDiv = document.getElementById(tableDivId);

            // If a table already exists in our custom div, remove it
            tableDiv.innerHTML = " ";
            tableDiv.classList.add("width-full", "mx-5", "my-5", "overflow-x-auto", "shadow-md", "sm:rounded-lg");

            var table = tableDiv.appendChild(document.createElement('table'));
            var tb_style = document.getElementsByTagName('table')[0];
            tb_style.classList.add("w-full", "whitespace-no-wrap");
            var lastColumnIsSelectionData = false;
            // Create headers from column info
            addHeaderRow(columnInfo.map(function (c) {
                return c.label;
            }));

            // Create table body for incoming data
            var tableBody = table.appendChild(document.createElement('tbody'));
            document.getElementsByTagName('tbody')[0].classList.add("bg-white", "divide-y", "dark:divide-gray-700", "dark:bg-gray-800");
            console.log(columnInfo);
            // Add remaining rows to table body
            if (jsonData) {
                for (var i = 0; i < jsonData.length; i++) {

                    addDataRow(jsonData[i], columnInfo);

                }
            }

            // Append a header row to the table
            function addHeaderRow(columnLabels) {
                // Create table row
                var tableHead = document.createElement('thead');
                var tr = document.createElement('tr');
                tr.classList.add("text-m", "mx-3", "font-bold", "tracking-wide", "text-center", "text-white", "uppercase", "border-b", "bg-purple-700");

                var visiblecols = 11;
                var col = 1;
                // Add a header cell for each column heading
                columnLabels.forEach(function (header) {

                    if (header != 'Min Policies' && header != 'Max Policies' && header != 'Product_Info_Multiplier') {
                        tr.appendChild(createElementWithText('th', header, col > visiblecols));
                        col = col + 1;
                    }

                });


                tableHead.appendChild(tr);

                table.appendChild(tableHead);
            }

            // Append a data row to the table
            function addDataRow(dataFields, format) {

                addDataRow.rowNum = ++addDataRow.rowNum || 0;
                var tr = document.createElement('tr');


                // Add table cell for each data field
                var valinput = document.createElement('input');
                var valoutput = document.createElement('output');
                valoutput.setAttribute('id', `output${addDataRow.rowNum}`);
                valinput.type = 'range';
                valinput.setAttribute('id', `policy${addDataRow.rowNum}`);
                valinput.setAttribute('name', 'userinput');
                valinput.setAttribute('oninput', `updater(${addDataRow.rowNum})`);
                var min = dataFields[3];
                var max = dataFields[4];

                valinput.setAttribute('min', min);
                valinput.setAttribute('max', max);

                // valinput.addEventListener('change', sendInput);
                var valinputCell = document.createElement('td');


                // Add table cell for each data field
                // var valinput2 = document.createElement('input');
                // valinput2.type = 'number';
                // valinput2.setAttribute('id', addDataRow.rowNum);
                // valinput2.setAttribute('name', 'userinput');
                //valinput.addEventListener('change', sendInput);
                // var valinputCell2 = document.createElement('td');
                var visiblecols = 13;
                dataFields.forEach(function (field, index) {
                    let unique = '';
                    let pmult = '';
                    let risk = '';
                    if (format[index].label == "Policy Slider" && field == "") {

                        valinput.setAttribute('value', dataFields[3]);

                        valinputCell.appendChild(valinput);
                        valinputCell.appendChild(valoutput);
                        valinputCell.className = "bg-gray-100 text-center";
                        tr.appendChild(valinputCell);
                        return;
                    }
                    if (format[index].label == "Min Policies" || format[index].label == "Max Policies" || format[index].label == "Product_Info_Multiplier") {
                        return;
                    }
                    if (format[index].label == 'Revised VAR') {
                        unique = 'rv' + `${addDataRow.rowNum}`;
                        pmult = dataFields[12].toFixed(format[index].format.precision);
                        risk = (dataFields[5] * 100).toFixed(2);

                    }
                    else if (format[index].label == 'Revised Premium') {
                        unique = 'rp' + `${addDataRow.rowNum}`;

                    }
                    else if (format[index].label == 'Revised Fees') {
                        unique = 'rf' + `${addDataRow.rowNum}`;

                    }
                    else if (format[index].label == 'Risk Percentage') {
                        unique = 'risk' + `${addDataRow.rowNum}`;
                    }




                    var td = createElementWithText('td', field, format[index].format, (visiblecols < index + 1));
                    if (!isNaN(field)) {
                        td.className = 'numeric font-semibold bg-gray-100 text-center px-4 py-3 text-sm text-black'; // Set numeric class to align numeric cells
                        td.setAttribute('id', unique);
                        td.setAttribute('pmult', `${pmult}`);
                        td.setAttribute('risk', `${risk}`);

                    }
                    tr.appendChild(td);

                });


                // valinput2.setAttribute('value',dataFields[dataFields.length-1]);
                // valinputCell2.appendChild(valinput2);
                // tr.appendChild(valinputCell2);

                tableBody.appendChild(tr);
            }
        }


    </script>
</head>

<body>
    <div id="sample"></div>

    <script>
        function updater(unique) {
            var x = document.getElementById(`policy${unique}`).value;
            var pmult = document.getElementById(`rv${unique}`).getAttribute('pmult');
            var risk = document.getElementById(`rv${unique}`).getAttribute('risk');
            var rv = risk * (1 - (pmult * 0.01)) * 0.005 * x;
            rv = rv.toFixed(2);
            var rp = 1.3 * rv;
            rp = rp.toFixed(2);
            var rf = rp - rv;
            rf = rf.toFixed(2);
            document.getElementById(`output${unique}`).innerHTML = x;
            document.getElementById(`rv${unique}`).innerHTML = rv;
            document.getElementById(`rp${unique}`).innerHTML = rp;
            document.getElementById(`rf${unique}`).innerHTML = rf;

        }
    </script>
</body>

</html>